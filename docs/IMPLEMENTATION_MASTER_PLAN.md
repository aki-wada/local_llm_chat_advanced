# Local LLM Chat Advanced v1.0 - 高完成度実装マスタープラン

**文書バージョン**: 1.0  
**作成日**: 2026-02-15  
**対象リポジトリ**: `/Users/m4_max/Desktop/wada_work/local_llm_chat_v2`  
**目的**: 機能仕様に対する不足分を、品質基準付きで段階実装するための実行計画と進捗記録

---

## 1. 本計画書の位置づけ

本書は以下を統合した実行ドキュメントです。

- `docs/FUNCTIONAL_SPEC.md` の必須要件
- `docs/UI_DESIGN_SPEC.md` のデザイン要件
- `docs/TECHNICAL_ARCHITECTURE.md` の技術方針
- `docs/IMPLEMENTATION_CHECKLIST.md` のフェーズ手順
- 現在の実装状態（2026-02-15時点）

本書では、単なるタスクリストではなく、**品質ゲート・受入条件・リスク対策・進捗記録**を明示します。

---

## 2. これまでの経過（実施ログ）

### 2.1 タイムライン

| 日付 | 実施内容 | 成果物 |
|------|---------|--------|
| 2026-02-15 | `docs` 4種を確認し、仕様ベースで新規実装開始 | 仕様把握完了 |
| 2026-02-15 | アプリ基盤を新規作成（HTML/CSS/JS） | `index.html`, `assets/app.css`, `js/app.js` |
| 2026-02-15 | コア機能を実装（SSE送信、設定保存、履歴、添付、D&D、画像ペースト等） | 初期動作版 |
| 2026-02-15 | UIをmacOS風へ大幅改修（ガラス調、質感、ダーク統合） | `assets/app.css` 改修 |
| 2026-02-15 | SVGアイコン化とアニメーション追加 | `index.html`, `assets/app.css`, `js/app.js` |
| 2026-02-15 | アイコンのみUI + ホバー時機能表示（ツールチップ）へ変更 | 操作UI統一 |
| 2026-02-15 | タイトルを `Local LLM Chat Advanced` のみに統一 | `index.html` 更新 |

### 2.2 現在の実装資産

- エントリ: `index.html`
- スタイル: `assets/app.css`
- ロジック: `js/app.js`（単一ファイル、約648行）

### 2.3 現在の品質状態（要約）

- 画面は利用可能（UIはモダン化済み）
- 通常チャットは利用可能（SSE/停止/添付あり）
- 仕様上の必須機能は未充足あり（F-08〜F-14中心）

---

## 3. 仕様ギャップ分析（2026-02-15時点）

### 3.1 機能別ステータス

| ID | 機能 | 状態 | 補足 |
|----|------|------|------|
| F-01 | チャット送受信 | 部分実装 | SSE/Stopは実装済み。細部の堅牢性強化余地あり |
| F-02 | モデル選択 | 部分実装 | 一覧取得・選択・load/unloadあり。表示情報拡張が不足 |
| F-03 | 設定管理 | 部分実装 | 基本設定あり。仕様項目の一部（response style等）未実装 |
| F-04 | 履歴管理 | 部分実装 | 保存・復元あり。export/import未実装 |
| F-05 | Markdown表示 | 部分実装 | 簡易パーサ。仕様準拠の本格対応未完了 |
| F-06 | 画像添付 | 実装済み（要強化） | Vision送信あり。UI検証・例外系強化余地 |
| F-07 | ファイル添付 | 実装済み（要強化） | text/pdf対応。pdf.js未読込時フォールバックあり |
| F-08 | プリセットプロンプト | 未実装 |  |
| F-09 | 深掘りモード | 未実装 |  |
| F-10 | モデル比較 | 未実装 |  |
| F-11 | ヘルプモード | 未実装 |  |
| F-12 | 信頼度・代替候補表示 | 未実装 |  |
| F-13 | 医学用語チェック | 未実装 |  |
| F-14 | System Promptプリセット | 未実装 |  |
| F-15 | 自動アンロード | 実装済み（要検証） | 切替時呼び出しあり |
| F-16 | ダークモード | 実装済み |  |
| F-17 | スマートスクロール | 部分実装 | near-bottom判定あり。追従制御は強化余地 |
| F-18 | 新しい話題 | 実装済み | 区切り追加 |
| F-19 | メッセージ編集 | 未実装 |  |
| F-20 | 再生成 | 実装済み（要検証） | ロールバック再送あり |
| F-21 | 下書き自動保存 | 実装済み | 300msデバウンス |
| F-22 | D&D | 実装済み |  |
| F-23 | 画像ペースト | 実装済み |  |

### 3.2 優先度定義

- P0: 必須未実装（F-08, 09, 10, 11, 12, 13, 14, 19, F-04 export/import）
- P1: 部分実装の仕様準拠化（F-01, 02, 03, 05, 17）
- P2: UX磨き込み・アクセシビリティ・文言統一

---

## 4. 完成度基準（Definition of Done）

### 4.1 機能完成基準

1. 仕様必須機能（F-01〜F-23）がUIから到達可能であること  
2. 機能ON/OFF状態がlocalStorageに保持されること  
3. API未対応時にアプリが中断せず、代替挙動または明示エラーを出すこと

### 4.2 品質基準

1. 致命的UI崩れなし（Desktop 1366px, Mobile 390px基準）  
2. SSE中断・ネットワーク失敗・不正レスポンスでフリーズしないこと  
3. 履歴編集/再生成/比較実行後も履歴整合が崩れないこと

### 4.3 保守性基準

1. `js/app.js` 内を機能セクション化し責務を固定  
2. 関数命名とストレージキーの一貫性確保  
3. 主要フローに最小コメントを付与

---

## 5. 実装戦略（高完成度向け）

### 5.1 基本方針

- 先に「状態設計・保存設計」を固め、UI実装は後追いで接続
- 新機能追加時は「失敗時フォールバック」を先に定義
- 1フェーズごとに回帰確認を実施（送受信・履歴・設定は毎回確認）

### 5.2 実装順序（依存関係を考慮）

1. 設定/状態の拡張
2. 会話構築ロジック（System Prompt注入）
3. プリセット群
4. 履歴の高度機能（編集/export/import）
5. モデル比較
6. logprobs
7. 医学用語チェック
8. 総合調整

---

## 6. フェーズ別詳細計画

## Phase 0: リファクタ準備（0.5日）

**目的**: 以後の機能追加で破綻しない基盤化

- `state` 拡張:
  - `featureFlags`: deepDive, helpMode, compareMode, showLogprobs
  - `presets`, `systemPromptPresets`
  - `compare`: modelA/modelB/results/streaming状態
- ストレージキー拡張とマイグレーション関数追加
- 関数セクション見出しの整理（設定/チャット/添付/比較等）

**受入条件**
- 既存設定・履歴が壊れず起動できる
- コンソールに未捕捉例外が出ない

## Phase 1: 設定仕様の完全化（0.75日）

**対象**: F-03未実装分

- UI追加: `sendKey`, `responseStyle`, `userLevel`, `userProfession`, `userInterests`, `showLogprobs`
- 保存・復元ロジック実装
- ダークモード即時保存の仕様合わせ

**受入条件**
- リロード後に全設定値が一致
- `Enter` / `Ctrl+Enter` 切替が動作

## Phase 2: 会話構築の高度化（0.5日）

**対象**: F-01/F-03/F-09/F-11の土台

- `buildApiMessages` 拡張:
  - responseStyle指示文
  - user profile指示文
  - deep dive指示文
  - help mode時の操作説明文注入
- API送信履歴は最大ターン制限を厳密化

**受入条件**
- 各設定でプロンプト構成が意図通りに変化

## Phase 3: プリセット機能（1.0日）

**対象**: F-08, F-14

- デフォルト6種プリセット定義
- 挿入UI（ポップオーバー）
- カスタムプリセットCRUD
- System Promptプリセット（保存/選択/削除）

**受入条件**
- 追加したプリセットが再起動後も保持
- System Promptプリセットの切替が即時反映

## Phase 4: 履歴拡張（0.75日）

**対象**: F-04, F-19, F-20品質向上

- メッセージ編集機能（ユーザー発言のみ）
- 編集時ロールバックと再送
- 履歴export/import（JSON）
- import時のスキーマ検証

**受入条件**
- 編集後の会話整合が保たれる
- 不正JSON importで安全に失敗する

## Phase 5: モデル比較（1.25日）

**対象**: F-10

- 比較モードUI（Model A/B選択）
- 並列送信・並列SSE処理
- 比較表示レイアウト（2カラム）
- 中断・失敗時の片系継続

**受入条件**
- 2モデル結果を同時表示
- 一方失敗時も他方結果は保持

## Phase 6: logprobs（1.0日）

**対象**: F-12

- `logprobs` パラメータ付き送信
- トークン信頼度・代替候補表示UI
- 非対応モデル時フォールバック

**受入条件**
- showLogprobs ONでのみ表示
- 非対応時に明示メッセージを出して通常応答継続

## Phase 7: 医学用語チェック（0.75日）

**対象**: F-13

- 対象メッセージを検証する補助プロンプト実装
- 判定結果をカード表示（要修正語、根拠、推奨置換）
- メッセージ単位起動

**受入条件**
- 任意メッセージから実行できる
- 結果が履歴と混線しない

## Phase 8: 総合仕上げ（0.75日）

- UI微調整（macOS風の整合、フォーカス状態）
- アクセシビリティ（aria/キーボード導線）
- 回帰テスト・不具合修正
- ドキュメント更新

**受入条件**
- 必須機能一覧の未実装ゼロ
- 重大バグゼロでリリース候補化

---

## 7. テスト計画（高完成度向け）

### 7.1 回帰必須シナリオ（毎フェーズ実施）

1. モデル選択 -> 送信 -> ストリーミング完了
2. ストリーミング中Stop
3. 設定変更 -> リロード -> 復元
4. 添付（image/text/pdf）送信
5. 履歴再表示

### 7.2 機能別重点テスト

- プリセット: CRUD後の永続化
- 比較: 同時実行、片側失敗、停止
- logprobs: 対応/非対応モデルの分岐
- 医学用語チェック: 長文・空文・特殊文字
- import: 正常JSON/不正JSON/巨大JSON

### 7.3 エラー耐性試験

- APIタイムアウト
- 不正SSEチャンク
- `localStorage`破損データ
- モデル一覧取得失敗

---

## 8. リスクと対策

| リスク | 影響 | 対策 |
|-------|------|------|
| 単一JS肥大化 | 保守性低下 | セクション化、命名規約、小関数化 |
| API差異（LM Studio/Ollama） | 機能不全 | 機能検出 + フォールバック |
| logprobs未対応モデル | UI破綻 | 非対応メッセージ表示で通常モード継続 |
| 比較モードの並列処理競合 | フリーズ/破損 | 個別AbortController管理 |
| 履歴編集の整合崩れ | データ破損 | 編集前スナップショット + 検証 |

---

## 9. 実行管理（進捗記録テンプレート）

以下形式で都度更新する。

```markdown
### YYYY-MM-DD HH:mm
- Phase: X
- 実施: ...
- 変更ファイル: ...
- 結果: ...
- 残課題: ...
```

### 進捗ログ（初期記録）

### 2026-02-15
- Phase: 準備
- 実施: 仕様書確認、初期実装、macOS風UI改修、アイコン化、タイトル統一
- 変更ファイル: `index.html`, `assets/app.css`, `js/app.js`
- 結果: コア機能の一部は利用可能。必須機能の未実装範囲を特定済み
- 残課題: F-08, F-09, F-10, F-11, F-12, F-13, F-14, F-19, export/import

### 2026-02-15 (Phase 0-2 反映)
- Phase: 0〜2
- 実施: state/設定スキーマ拡張、legacyキーの読み込み移行、設定UI追加、sendKey切替、deepDive/helpMode切替、会話構築プロンプト注入の実装
- 変更ファイル: `index.html`, `assets/app.css`, `js/app.js`
- 結果: 設定仕様の不足分と会話構築の基盤を反映。送信フローの履歴重複問題も同時修正
- 残課題: F-08, F-10, F-12, F-13, F-14, F-19, export/import（および既存機能の総合検証）

### 2026-02-15 (Phase 3 反映)
- Phase: 3
- 実施: テキストプリセットのポップオーバー挿入、設定内プリセットCRUD、System Promptプリセット保存/適用/削除を実装
- 変更ファイル: `index.html`, `assets/app.css`, `js/app.js`
- 結果: F-08/F-14の基礎機能を実装。localStorage連携で再起動後も保持
- 残課題: F-10, F-12, F-13, F-19, export/import（および総合検証）

### 2026-02-15 (Phase 4 反映)
- Phase: 4
- 実施: ユーザーメッセージ編集（再送モード）、履歴エクスポート/インポート（JSON）を実装
- 変更ファイル: `index.html`, `js/app.js`
- 結果: F-19 と F-04のexport/importを実装。既存履歴上書きインポートとエラーハンドリングを追加
- 残課題: F-10, F-12, F-13（および総合検証）

### 2026-02-15 (Phase 5-7 反映)
- Phase: 5〜7
- 実施: 比較モード（Model A/B並列ストリーミング）、logprobs表示、医学用語チェックを実装
- 変更ファイル: `index.html`, `assets/app.css`, `js/app.js`
- 結果: F-10/F-12/F-13の基礎機能を反映。Stopで比較モードの両系統停止にも対応
- 残課題: 総合検証、挙動チューニング、例外系テスト

---

## 10. 次アクション（実行順）

1. Phase 0を着手し、状態/保存スキーマを拡張  
2. Phase 1で設定UIの不足項目を埋める  
3. Phase 2まで完了した時点で中間レビュー（会話構築の妥当性確認）

# Handoff Note - Local LLM Chat Advanced v2.1 (2026-02-19)

## 目的
v2.0 → v2.1 の変更内容と、次回再開のための記録。

## 対象
- アプリ名: `Local LLM Chat Advanced`
- バージョン: `v2.1`

## 今回の実装サマリ

### 1. Thinking model 対応（思考プロセスの分離表示）
- `renderMarkdown()` 内で思考タグを検出し、本文と思考内容を分離
- 5パターンに対応（対応順に記載）:
  - Pattern 1: `<think>content</think>` — Qwen3, DeepSeek R1
  - Pattern 2: `<think>content` — ストリーミング中の部分思考
  - Pattern 3: `content</think>` — nemotron-3-nano（開きタグなし）
  - Pattern 4: `<unusedNN>thought content` — medgemma（閉じタグなし）
  - Pattern 5: `<seed:think>content</seed:think>` — プレフィックス付き think タグ
- Pattern 1-3, 5 は正規表現 `<(?:\w+:)?think>` で統一的に処理
- 思考内容は折りたたみブロック（`<details class="thinking-block">`）で表示
- CSS スタイルを `assets/app.css` に追加

### 2. Reasoning Effort 設定（gpt-oss-120B 対応）
- `Reasoning Effort` ドロップダウンを設定パネル > 接続セクションに追加
- 選択肢: `off`（デフォルト）/ `low` / `medium` / `high`
- `off` 以外の場合、ペイロードに `reasoning: { effort: "..." }` を追加
- `applyReasoningToPayload()` ヘルパーで4箇所（通常送信・比較A・比較B・再開）を共通化

### 3. delta.reasoning フィールドの処理
- `streamChatCompletion()` を拡張して `delta.reasoning` を抽出
- ストリーミング中に `state.history[index].reasoning` に蓄積
- `updateReasoningBlock()` で思考ブロックをリアルタイム更新
- `appendMessage()` で保存済みメッセージの思考ブロックも表示

### 4. 思考プロセス非表示トグル
- `hideThinking` 設定（チェックボックス）を詳細モードセクションに追加
- ON にすると思考ブロックを DOM に挿入しない
- `renderMarkdown()` と `updateReasoningBlock()` の両方で表示を抑制

### 5. バグ修正: settingsChangeControls 登録漏れ
- `el.reasoningEffortSelect` と `el.hideThinkingInput` が `settingsChangeControls` 配列に未登録
- チェックボックス / セレクトの変更が `saveSettingsFromUI()` をトリガーしなかった
- 配列に2要素を追加して修正

## 主な更新ファイル
| ファイル | 変更内容 |
|---------|---------|
| `index.html` | Reasoning Effort ドロップダウン、hideThinking チェックボックス追加、キャッシュバスティング v2.4 |
| `js/app.js` | 思考分離処理、reasoning API、設定追加、settingsChangeControls 修正 |
| `assets/app.css` | `.thinking-block`, `.thinking-summary`, `.thinking-content` スタイル追加 |
| `docs/MANUAL.md` | セクション10「思考プロセス表示」追加、設定パネル説明更新 |
| `docs/FUNCTIONAL_SPEC.md` | F-24〜F-26 追加、設定テーブル更新、API仕様更新 |
| `docs/TECHNICAL_ARCHITECTURE.md` | SSE reasoning 処理、think タグ分離ロジック追加 |
| `README.md` | 機能リストに思考プロセス対応を追加 |

## コミット履歴（本セッション）
1. `25886ce` feat: thinking model対応（<think>タグ分離 + reasoning effort設定）
2. `74c125f` feat: 思考プロセス非表示トグルを追加
3. `d4cf048` fix: settingsChangeControls に reasoningEffort と hideThinking を登録
4. `20f3463` docs: v2.1 thinking/reasoning 機能のドキュメント更新
5. `44da5d0` feat: medgemma の <unusedNN>thought 思考タグに対応 (Pattern 4)
6. `0c3d8a8` feat: <seed:think> 等プレフィックス付き think タグに対応 (Pattern 5)

## Thinking タグ対処経過

| 段階 | コミット | 対応内容 | 対象モデル |
|------|---------|---------|-----------|
| 初期実装 | `25886ce` | Pattern 1-3（`<think>` タグ3パターン）+ Reasoning Effort UI | Qwen3, DeepSeek R1, nemotron-3-nano |
| 非表示対応 | `74c125f` | hideThinking トグル追加 | 全モデル共通 |
| バグ修正 | `d4cf048` | settingsChangeControls 登録漏れ修正（hideThinking が保存されない問題） | — |
| Pattern 4 | `44da5d0` | `<unusedNN>thought` タグ対応（閉じタグなし形式） | medgemma-27b |
| Pattern 5 | `0c3d8a8` | `<seed:think>` 等プレフィックス付き think タグ対応。Pattern 1-3 の正規表現を `<(?:\w+:)?think>` に汎用化 | olmo-3等 |

### 正規表現の変遷

```
# 初期（Pattern 1-3）
/<think>([\s\S]*?)<\/think>/g
/<think>([\s\S]*)$/
/^([\s\S]*?)<\/think>([\s\S]*)$/

# Pattern 5 対応後（現在）
/<(?:\w+:)?think>([\s\S]*?)<\/(?:\w+:)?think>/g
/<(?:\w+:)?think>([\s\S]*)$/
/^([\s\S]*?)<\/(?:\w+:)?think>([\s\S]*)$/

# Pattern 4（medgemma、独立パターン）
/^([\s\S]*?)<unused\d+>thought([\s\S]*)$/
```

### IgakuQA 側の対応

IgakuQA 評価スクリプト（`strip_thinking()`）にも同一の正規表現拡張を適用済み:
- `evaluate_llm.py`
- `evaluate_lmstudio_batch.py`
- `evaluate_prompt_comparison.py`

## 再開時の手順
1. マニュアル同期:
   ```bash
   node scripts/sync-manual-embed.mjs
   ```
2. ブラウザでハードリロード（Cmd+Shift+R）
3. 回帰確認:
   - nemotron-3-nano 等で思考プロセスが折りたたみ表示されること
   - gpt-oss-120B で Reasoning Effort 設定が反映されること
   - hideThinking ON で思考ブロックが非表示になること
   - `<seed:think>` タグを出力するモデルでも思考分離されること
   - medgemma の `<unusedNN>thought` タグも分離されること
   - 従来の `<think>` タグなしモデルも正常に動作すること
   - 比較モードで reasoning パラメータが送信されること

## 次回の優先候補
1. 非ストリーミングモードでの `message.reasoning` フィールド処理
2. reasoning 内容の Markdown エクスポート対応
3. 新しい思考タグ形式が出た場合のパターン追加
